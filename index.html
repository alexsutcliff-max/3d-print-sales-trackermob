# Create a GitHub Pages–safe index.html that avoids common white-screen causes:
# - Use PRODUCTION React/ReactDOM builds from jsDelivr
# - Keep Babel Standalone but ensure load order
# - Add robust boot logging + error boundary to surface issues
# - Temporarily DISABLE service worker registration (can re-enable later)
# - Works under subpath (/3d-print-sales-trackermob/)
# Writes file to /mnt/data/index-gh-pages-safe.html

content = r"""<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0b0b0b" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icon-192.png" />
    <title>Print Sales Tracker</title>
    <script>
      // Simple boot logger so we can see load stages in the console
      (function(){ window.__bootlog = function(){ console.log('[BOOT]', ...arguments);} })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 72px); }
      .bottom-bar { height: 64px; padding-bottom: env(safe-area-inset-bottom, 0px); }
    </style>
  </head>
  <body class="bg-gray-100">
    <noscript>This app needs JavaScript enabled.</noscript>
    <div id="root" class="safe-bottom">Loading…</div>

    <!-- Load libs (prod builds) -->
    <script>__bootlog('loading libs');</script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>
    <script>__bootlog('libs loaded');</script>

    <!-- App -->
    <script type="text/babel">
      __bootlog('app script start');
      const { useState, useMemo, useEffect, useRef } = React;
      const {
        BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Legend, LabelList, Cell,
        PieChart, Pie, ResponsiveContainer, LineChart, Line, Brush
      } = Recharts;

      const fmtMoney = (currency, n) => `${currency}${(Number(n) || 0).toFixed(2)}`;
      const todayISO = () => new Date().toISOString().split("T")[0];

      const escapeCSV = (v) => { if (v==null) return ""; const s=String(v); return /[",\\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; };
      const toCSV = (rows, cols) => [cols.join(","), ...rows.map(r=>cols.map(c=>escapeCSV(r[c])).join(","))].join("\\n");
      const downloadCSV = (filename, csv) => { const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url;a.download=filename;a.click(); URL.revokeObjectURL(url); };

      function ErrorBoundary({ children }) {
        const [err, setErr] = useState(null);
        return err ? (
          <div className="p-4 m-4 bg-red-50 border border-red-200 rounded-xl text-sm text-red-700">
            <div className="font-semibold mb-1">App error</div>
            <pre className="whitespace-pre-wrap">{String(err.stack || err.message || err)}</pre>
          </div>
        ) : (
          <React.ErrorBoundary fallbackRender={({error}) => { setErr(error); return null; }}>{children}</React.ErrorBoundary>
        );
      }

      function App() {
        const [tab, setTab] = useState("sales");
        const [sales, setSales] = useState([
          { date: "2025-08-01", item: "T-Rex Skull Replica", channel: "Website", filamentCost: 8.5, powerCost: 1.2, otherCosts: 0.5, deliveryCost: 5, totalCost: 15.2, price: 50, taxAmount: 10, profit: 24.8, printingTime: 10, taxRate: "20" },
          { date: "2025-08-02", item: "Velociraptor Claw Model", channel: "Cash", filamentCost: 3.2, powerCost: 0.75, otherCosts: 0.4, deliveryCost: 0, totalCost: 4.35, price: 18, taxAmount: 3.6, profit: 10.05, printingTime: 4, taxRate: "20" },
          { date: "2025-08-03", item: "Triceratops Horn Replica", channel: "Ebay", filamentCost: 6, powerCost: 1.0, otherCosts: 0.6, deliveryCost: 4, totalCost: 11.6, price: 40, taxAmount: 8, profit: 20.4, printingTime: 8, taxRate: "20" },
        ]);
        const [items, setItems] = useState([
          { id: 1, name: "T-Rex Skull Replica", filamentCost: 8.5, powerCost: 1.2, otherCosts: 0.5, printingTime: 10, removed: false },
          { id: 2, name: "Velociraptor Claw Model", filamentCost: 3.2, powerCost: 0.75, otherCosts: 0.4, printingTime: 4, removed: false },
          { id: 3, name: "Triceratops Horn Replica", filamentCost: 6, powerCost: 1.0, otherCosts: 0.6, printingTime: 8, removed: false },
        ]);
        const [channels, setChannels] = useState(["Website","Ebay","Cash"]);
        const [expenses, setExpenses] = useState([
          { category: "Filament Purchase", name: "Bulk PLA Filament", cost: 30, date: "2025-07-28", auto: false },
          { category: "Machine Repairs", name: "Extruder Replacement", cost: 15, date: "2025-07-29", auto: false },
          { category: "Waste Filament", name: "Failed Prints", cost: 5, date: "2025-07-30", auto: false },
          { category: "COGS – Filament", name: "T-Rex Skull Replica (filament)", cost: 8.5, date: "2025-08-01", auto: true },
          { category: "COGS – Power", name: "T-Rex Skull Replica (power)", cost: 1.2, date: "2025-08-01", auto: true },
          { category: "COGS – Other", name: "T-Rex Skull Replica (other)", cost: 0.5, date: "2025-08-01", auto: true },
          { category: "COGS – Delivery", name: "T-Rex Skull Replica (delivery)", cost: 5, date: "2025-08-01", auto: true },
        ]);
        const [showCOGS, setShowCOGS] = useState(true);
        const [showCash, setShowCash] = useState(true);
        const [rangeStart, setRangeStart] = useState(sales[0]?.date ?? (new Date()).toISOString().split("T")[0]);
        const [rangeEnd, setRangeEnd] = useState(sales[sales.length-1]?.date ?? (new Date()).toISOString().split("T")[0]);
        const [currency, setCurrency] = useState(localStorage.getItem("currency") || "£");
        useEffect(()=>localStorage.setItem("currency", currency), [currency]);

        const [saleForm, setSaleForm] = useState({ item: "T-Rex Skull Replica", price: "", channel: "Website", taxRate: "20", date: (new Date()).toISOString().split("T")[0] });
        const [newItem, setNewItem] = useState({ name: "", filamentCost: "", powerCost: "", otherCosts: "", printingTime: "" });
        const [newChannel, setNewChannel] = useState("");
        const [newExpense, setNewExpense] = useState({ category: "Machine Repairs", name: "", cost: "", date: (new Date()).toISOString().split("T")[0] });

        const idCounter = useRef(1000);
        const genId = () => idCounter.current++;

        const filteredExpenses = useMemo(()=> (showCOGS ? expenses : expenses.filter(e=>!e.category.startsWith("COGS –"))), [expenses, showCOGS]);

        const totalFilamentPurchase = useMemo(()=> expenses.filter(e=>e.category==="Filament Purchase").reduce((a,e)=>a+(e.cost||0),0), [expenses]);
        const totalFilamentUsed = useMemo(()=> expenses.filter(e=>e.category==="COGS – Filament").reduce((a,e)=>a+(e.cost||0),0), [expenses]);
        const netFilamentCost = Math.max(0, totalFilamentPurchase - totalFilamentUsed);

        const totals = useMemo(()=>{
          const revenue = sales.reduce((a,s)=>a+(s.price||0),0);
          const cogsNonFilament = expenses.filter(e=>e.category.startsWith("COGS –") && e.category!=="COGS – Filament").reduce((a,e)=>a+(e.cost||0),0);
          const cogs = cogsNonFilament + netFilamentCost;
          const other = expenses.filter(e=>!e.category.startsWith("COGS –") && e.category!=="Filament Purchase").reduce((a,e)=>a+(e.cost||0),0);
          const grossProfit = revenue - cogs;
          const netProfit = grossProfit - other;
          return { revenue, cogs, other, grossProfit, netProfit };
        }, [sales, expenses, netFilamentCost]);

        const salesOnly = useMemo(()=>{
          const compute = (arr)=>arr.reduce((acc,s)=>{
            const item = items.find(i=>i.name===s.item);
            const cogs = (item?.filamentCost||0)+(item?.powerCost||0)+(item?.otherCosts||0)+(s.deliveryCost||0);
            const price = s.price||0;
            const tax = price * ((parseFloat(s.taxRate)||0)/100);
            acc.revenue += price; acc.cogs += cogs; acc.tax += tax; return acc;
          }, {revenue:0,cogs:0,tax:0});
          const byRange = (arr)=>arr.filter(s=>s.date>=rangeStart && s.date<=rangeEnd);
          const all = compute(byRange(sales));
          const exclCash = compute(byRange(sales.filter(s=>s.channel!=="Cash")));
          return { all, exclCash, active: showCash ? all : exclCash };
        }, [sales, items, showCash, rangeStart, rangeEnd]);

        const timeData = useMemo(()=>{
          const acc = sales.reduce((acc,s)=>{
            if(!acc[s.item]) acc[s.item]={item:s.item, hours:0, profit:0, count:0};
            acc[s.item].hours += s.printingTime||0;
            const item = items.find(i=>i.name===s.item); if(!item) return acc;
            const tax = (s.price||0)*((parseFloat(s.taxRate)||0)/100);
            const totalCost = (item.filamentCost||0)+(item.powerCost||0)+(item.otherCosts||0)+(s.deliveryCost||0);
            const profit = (s.price||0)-totalCost-tax;
            acc[s.item].profit += profit; acc[s.item].count+=1; return acc;
          },{});
          return Object.values(acc).map(e=>({...e, profitPerHour: e.hours>0? e.profit/e.hours:0})).sort((a,b)=>b.profitPerHour-a.profitPerHour);
        }, [sales, items]);
        const highest = timeData.length ? timeData[0].profitPerHour : 0;
        const lowest = timeData.length ? timeData[timeData.length-1].profitPerHour : 0;

        const lineData = useMemo(()=>{
          const map = new Map();
          const inRange = sales.filter(s=>s.date>=rangeStart && s.date<=rangeEnd && (showCash || s.channel!=="Cash"));
          inRange.forEach(s=>{
            const it = items.find(i=>i.name===s.item);
            const cogs = (it?.filamentCost||0)+(it?.powerCost||0)+(it?.otherCosts||0)+(s.deliveryCost||0);
            const price = s.price||0;
            const tax = price*((parseFloat(s.taxRate)||0)/100);
            const gross = price - cogs;
            const net = gross - tax;
            if(!map.has(s.date)) map.set(s.date, {date:s.date, revenue:0, cogs:0, gross:0, net:0});
            const row = map.get(s.date);
            row.revenue+=price; row.cogs+=cogs; row.gross+=gross; row.net+=net;
          });
          return Array.from(map.values()).sort((a,b)=> a.date<b.date?-1:1);
        }, [sales, items, rangeStart, rangeEnd, showCash]);

        const TabButton = ({ id, children }) => (
          <button onClick={()=>setTab(id)} className={`px-4 py-2 rounded-2xl text-sm font-medium transition shadow-sm border ${tab===id ? "bg-black text-white":"bg-white hover:bg-gray-50 text-gray-800"}`}>{children}</button>
        );

        function Stat({ label, value }) {
          return (<div className="bg-gray-50 rounded-2xl p-3 border"><div className="text-xs text-gray-500">{label}</div><div className="text-lg font-semibold">{value}</div></div>);
        }

        function CashComparison({ currency, salesOnly }) {
          const { all, exclCash } = salesOnly;
          const data = [
            { name: "Revenue", All: all.revenue, NoCash: exclCash.revenue },
            { name: "COGS", All: all.cogs, NoCash: exclCash.cogs },
            { name: "Gross Profit", All: all.revenue - all.cogs, NoCash: exclCash.revenue - exclCash.cogs },
            { name: "Net (after tax)", All: all.revenue - all.cogs - all.tax, NoCash: exclCash.revenue - exclCash.cogs - exclCash.tax },
          ];
          return (
            <div className="w-full h-72">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={data}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip formatter={(val)=>fmtMoney(currency,val)} />
                  <Legend />
                  <Bar dataKey="All" name="All sales"><LabelList dataKey="All" position="top" formatter={(v)=>fmtMoney(currency,v)} /></Bar>
                  <Bar dataKey="NoCash" name="Excl. Cash"><LabelList dataKey="NoCash" position="top" formatter={(v)=>fmtMoney(currency,v)} /></Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          );
        }

        function AppShell() {
          return (
            <div className="min-h-screen p-4 pb-24">
              <div className="max-w-5xl mx-auto">
                <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                  <h1 className="text-2xl font-bold">Print Sales Tracker</h1>
                  <div className="flex items-center gap-2">
                    <div className="hidden sm:flex gap-2">
                      {[["sales","Sales"],["items","Items"],["expenses","Expenses"],["analytics","Analytics"],["time","Time"]]
                        .map(([id,label])=>(<TabButton key={id} id={id}>{label}</TabButton>))}
                    </div>
                    <select className="ml-2 px-3 py-2 rounded-xl bg-white border" value={currency} onChange={(e)=>setCurrency(e.target.value)}>
                      <option value="£">£ GBP</option>
                      <option value="$">$ USD</option>
                      <option value="€">€ EUR</option>
                      <option value="¥">¥ JPY</option>
                    </select>
                  </div>
                </header>

                {/* Quick export buttons omitted for brevity */}

                <div className="text-sm text-gray-600">If you see this header, React rendered successfully.</div>
              </div>

              {/* Bottom nav stub */}
              <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center bottom-bar">
                {([["sales","Sales"],["items","Items"],["expenses","Expenses"],["analytics","Analytics"],["time","Time"]]).map(([id,label])=> (
                  <button key={id} onClick={()=>setTab(id)} className={`flex-1 py-3 text-sm ${tab===id? 'text-black font-semibold':'text-gray-600'}`}>{label}</button>
                ))}
              </nav>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><AppShell /></ErrorBoundary>);
        __bootlog('app mounted');
      }

      try { App(); } catch (e) { console.error(e); document.getElementById('root').textContent = 'App failed to start. Check console for errors.'; }
    </script>

    <script>
      // NOTE: temporarily disabled service worker to avoid cache-related white screens.
      // Re-enable after it works:
      // if ("serviceWorker" in navigator) window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
    </script>
  </body>
</html>
"""
path = "/mnt/data/index-gh-pages-safe.html"
with open(path, "w") as f:
    f.write(content)

path
