<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0b0b0b" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icon-192.png" />
    <title>Print Sales Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 72px); }
      .bottom-bar { height: 64px; padding-bottom: env(safe-area-inset-bottom, 0px); }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="root" class="safe-bottom"></div>

    <!-- Libraries -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>

    <!-- App -->
    <script type="text/babel" data-presets="react,env">

      const { useState, useMemo, useEffect, useRef } = React;
      const {
        BarChart, Bar, XAxis, YAxis, Tooltip, CartesianGrid, Legend, LabelList, Cell,
        PieChart, Pie, ResponsiveContainer, LineChart, Line, Brush
      } = Recharts;

      const fmtMoney = (currency, n) => `${currency}${(Number(n) || 0).toFixed(2)}`;
      const todayISO = () => new Date().toISOString().split("T")[0];

      const escapeCSV = (v) => { if (v==null) return ""; const s=String(v); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; };
      const toCSV = (rows, cols) => [cols.join(","), ...rows.map(r=>cols.map(c=>escapeCSV(r[c])).join(","))].join("\n");
      const downloadCSV = (filename, csv) => { const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url;a.download=filename;a.click(); URL.revokeObjectURL(url); };

      function App() {
        const [tab, setTab] = useState("sales");

        const [sales, setSales] = useState([
          { date: "2025-08-01", item: "T-Rex Skull Replica", channel: "Website", filamentCost: 8.5, powerCost: 1.2, otherCosts: 0.5, deliveryCost: 5, totalCost: 15.2, price: 50, taxAmount: 10, profit: 24.8, printingTime: 10, taxRate: "20" },
          { date: "2025-08-02", item: "Velociraptor Claw Model", channel: "Cash", filamentCost: 3.2, powerCost: 0.75, otherCosts: 0.4, deliveryCost: 0, totalCost: 4.35, price: 18, taxAmount: 3.6, profit: 10.05, printingTime: 4, taxRate: "20" },
          { date: "2025-08-03", item: "Triceratops Horn Replica", channel: "Ebay", filamentCost: 6, powerCost: 1.0, otherCosts: 0.6, deliveryCost: 4, totalCost: 11.6, price: 40, taxAmount: 8, profit: 20.4, printingTime: 8, taxRate: "20" },
        ]);

        const [items, setItems] = useState([
          { id: 1, name: "T-Rex Skull Replica", filamentCost: 8.5, powerCost: 1.2, otherCosts: 0.5, printingTime: 10, removed: false },
          { id: 2, name: "Velociraptor Claw Model", filamentCost: 3.2, powerCost: 0.75, otherCosts: 0.4, printingTime: 4, removed: false },
          { id: 3, name: "Triceratops Horn Replica", filamentCost: 6, powerCost: 1.0, otherCosts: 0.6, printingTime: 8, removed: false },
        ]);

        const [channels, setChannels] = useState(["Website","Ebay","Cash"]);

        const [expenses, setExpenses] = useState([
          { category: "Filament Purchase", name: "Bulk PLA Filament", cost: 30, date: "2025-07-28", auto: false },
          { category: "Machine Repairs", name: "Extruder Replacement", cost: 15, date: "2025-07-29", auto: false },
          { category: "Waste Filament", name: "Failed Prints", cost: 5, date: "2025-07-30", auto: false },
          { category: "COGS – Filament", name: "T-Rex Skull Replica (filament)", cost: 8.5, date: "2025-08-01", auto: true },
          { category: "COGS – Power", name: "T-Rex Skull Replica (power)", cost: 1.2, date: "2025-08-01", auto: true },
          { category: "COGS – Other", name: "T-Rex Skull Replica (other)", cost: 0.5, date: "2025-08-01", auto: true },
          { category: "COGS – Delivery", name: "T-Rex Skull Replica (delivery)", cost: 5, date: "2025-08-01", auto: true },
        ]);

        const [showCOGS, setShowCOGS] = useState(true);
        const [showCash, setShowCash] = useState(true);
        const [rangeStart, setRangeStart] = useState(sales[0]?.date ?? todayISO());
        const [rangeEnd, setRangeEnd] = useState(sales[sales.length-1]?.date ?? todayISO());
        const [currency, setCurrency] = useState(localStorage.getItem("currency") || "£");
        useEffect(()=>localStorage.setItem("currency", currency), [currency]);

        const [saleForm, setSaleForm] = useState({ item: "T-Rex Skull Replica", price: "", channel: "Website", taxRate: "20", date: todayISO() });
        const [newItem, setNewItem] = useState({ name: "", filamentCost: "", powerCost: "", otherCosts: "", printingTime: "" });
        const [newChannel, setNewChannel] = useState("");
        const [newExpense, setNewExpense] = useState({ category: "Machine Repairs", name: "", cost: "", date: todayISO() });

        const idCounter = useRef(1000);
        const genId = () => idCounter.current++;

        const filteredExpenses = useMemo(()=> (showCOGS ? expenses : expenses.filter(e=>!e.category.startsWith("COGS –"))), [expenses, showCOGS]);
        const totalFilamentPurchase = useMemo(()=> expenses.filter(e=>e.category==="Filament Purchase").reduce((a,e)=>a+(e.cost||0),0), [expenses]);
        const totalFilamentUsed = useMemo(()=> expenses.filter(e=>e.category==="COGS – Filament").reduce((a,e)=>a+(e.cost||0),0), [expenses]);
        const netFilamentCost = Math.max(0, totalFilamentPurchase - totalFilamentUsed);

        const totals = useMemo(()=>{
          const revenue = sales.reduce((a,s)=>a+(s.price||0),0);
          const cogsNonFilament = expenses.filter(e=>e.category.startsWith("COGS –") && e.category!=="COGS – Filament").reduce((a,e)=>a+(e.cost||0),0);
          const cogs = cogsNonFilament + netFilamentCost;
          const other = expenses.filter(e=>!e.category.startsWith("COGS –") && e.category!=="Filament Purchase").reduce((a,e)=>a+(e.cost||0),0);
          const grossProfit = revenue - cogs;
          const netProfit = grossProfit - other;
          return { revenue, cogs, other, grossProfit, netProfit };
        }, [sales, expenses, netFilamentCost]);

        const salesOnly = useMemo(()=>{
          const compute = (arr)=>arr.reduce((acc,s)=>{
            const item = items.find(i=>i.name===s.item);
            const cogs = (item?.filamentCost||0)+(item?.powerCost||0)+(item?.otherCosts||0)+(s.deliveryCost||0);
            const price = s.price||0;
            const tax = price * ((parseFloat(s.taxRate)||0)/100);
            acc.revenue += price; acc.cogs += cogs; acc.tax += tax; return acc;
          }, {revenue:0,cogs:0,tax:0});
          const byRange = (arr)=>arr.filter(s=>s.date>=rangeStart && s.date<=rangeEnd);
          const all = compute(byRange(sales));
          const exclCash = compute(byRange(sales.filter(s=>s.channel!=="Cash")));
          return { all, exclCash, active: showCash ? all : exclCash };
        }, [sales, items, showCash, rangeStart, rangeEnd]);

        const timeData = useMemo(()=>{
          const acc = sales.reduce((acc,s)=>{
            if(!acc[s.item]) acc[s.item]={item:s.item, hours:0, profit:0, count:0};
            acc[s.item].hours += s.printingTime||0;
            const item = items.find(i=>i.name===s.item); if(!item) return acc;
            const tax = (s.price||0)*((parseFloat(s.taxRate)||0)/100);
            const totalCost = (item.filamentCost||0)+(item.powerCost||0)+(item.otherCosts||0)+(s.deliveryCost||0);
            const profit = (s.price||0)-totalCost-tax;
            acc[s.item].profit += profit; acc[s.item].count+=1; return acc;
          },{});
          return Object.values(acc).map(e=>({...e, profitPerHour: e.hours>0? e.profit/e.hours:0})).sort((a,b)=>b.profitPerHour-a.profitPerHour);
        }, [sales, items]);
        const highest = timeData.length ? timeData[0].profitPerHour : 0;
        const lowest = timeData.length ? timeData[timeData.length-1].profitPerHour : 0;

        const lineData = useMemo(()=>{
          const map = new Map();
          const inRange = sales.filter(s=>s.date>=rangeStart && s.date<=rangeEnd && (showCash || s.channel!=="Cash"));
          inRange.forEach(s=>{
            const it = items.find(i=>i.name===s.item);
            const cogs = (it?.filamentCost||0)+(it?.powerCost||0)+(it?.otherCosts||0)+(s.deliveryCost||0);
            const price = s.price||0;
            const tax = price*((parseFloat(s.taxRate)||0)/100);
            const gross = price - cogs;
            const net = gross - tax;
            if(!map.has(s.date)) map.set(s.date, {date:s.date, revenue:0, cogs:0, gross:0, net:0});
            const row = map.get(s.date);
            row.revenue+=price; row.cogs+=cogs; row.gross+=gross; row.net+=net;
          });
          return Array.from(map.values()).sort((a,b)=> a.date<b.date?-1:1);
        }, [sales, items, rangeStart, rangeEnd, showCash]);

        // Actions
        const addItem = () => { if (!newItem.name.trim()) return;
          setItems(prev=>[...prev, { id: genId(), name: newItem.name.trim(), filamentCost: parseFloat(newItem.filamentCost)||0, powerCost: parseFloat(newItem.powerCost)||0, otherCosts: parseFloat(newItem.otherCosts)||0, printingTime: parseFloat(newItem.printingTime)||0, removed:false }]);
          setNewItem({ name: "", filamentCost: "", powerCost: "", otherCosts: "", printingTime: "" });
        };
        const editItem = (index, field, value) => { setItems(prev=>{ const u=[...prev]; u[index][field]= field==="name"? value: parseFloat(value)||0; return u; }); };
        const toggleItemStatus = (index) => setItems(prev=>{ const u=[...prev]; u[index].removed=!u[index].removed; return u; });
        const addChannel = () => { if(!newChannel.trim()) return; setChannels(prev=> Array.from(new Set([...prev, newChannel.trim()]))); setNewChannel(""); };
        const addSale = () => {
          const selectedItem = items.find(i=>i.name===saleForm.item);
          if (!selectedItem || !saleForm.price) return;
          let deliveryCost = 0;
          if (saleForm.channel !== "Cash") {
            const input = window.prompt("Enter delivery cost:", "0");
            deliveryCost = parseFloat(input||"0")||0;
          }
          const totalCost = (selectedItem.filamentCost||0)+(selectedItem.powerCost||0)+(selectedItem.otherCosts||0)+deliveryCost;
          const price = parseFloat(saleForm.price);
          const taxRate = parseFloat(saleForm.taxRate)||0;
          const taxAmount = (price*taxRate)/100;
          const profit = price - totalCost - taxAmount;
          const saleEntry = { ...saleForm, filamentCost:selectedItem.filamentCost, powerCost:selectedItem.powerCost, otherCosts:selectedItem.otherCosts, printingTime:selectedItem.printingTime, deliveryCost, totalCost, price, taxAmount, profit };
          setSales(prev=>[...prev, saleEntry]);
          setSaleForm(prev=>({...prev, price:"", date: todayISO()}));
          const cogsEntries = [
            { category: "COGS – Filament", name: `${saleEntry.item} (filament)`, cost: selectedItem.filamentCost },
            { category: "COGS – Power", name: `${saleEntry.item} (power)`, cost: selectedItem.powerCost },
            { category: "COGS – Other", name: `${saleEntry.item} (other)`, cost: selectedItem.otherCosts },
            { category: "COGS – Delivery", name: `${saleEntry.item} (delivery)`, cost: deliveryCost },
          ].map(e=>({...e, date: saleEntry.date, auto:true }));
          setExpenses(prev=>[...prev, ...cogsEntries]);
        };
        const deleteSale = (index) => setSales(prev=>{ const u=[...prev]; u.splice(index,1); return u; });
        const addExpense = () => { if(!newExpense.name.trim() || !newExpense.cost) return; setExpenses(prev=>[...prev, { ...newExpense, name: newExpense.name.trim(), cost: parseFloat(newExpense.cost), auto:false }]); setNewExpense({ category: "Machine Repairs", name: "", cost: "", date: todayISO() }); };
        const deleteExpense = (index) => setExpenses(prev=>{ if(prev[index]?.auto) return prev; const u=[...prev]; u.splice(index,1); return u; });

        // CSV
        const exportSalesCSV = () => downloadCSV("sales.csv", toCSV(sales, ["date","item","channel","price","taxRate","taxAmount","deliveryCost","totalCost","profit","printingTime"]));
        const exportItemsCSV = () => downloadCSV("items.csv", toCSV(items, ["id","name","filamentCost","powerCost","otherCosts","printingTime","removed"]));
        const exportExpensesCSV = () => downloadCSV("expenses.csv", toCSV(filteredExpenses, ["date","category","name","cost","auto"]));
        const exportAnalyticsCSV = () => downloadCSV("analytics_timeseries.csv", toCSV(lineData, ["date","revenue","cogs","gross","net"]));

        const TabButton = ({ id, children }) => (<button onClick={()=>setTab(id)} className={`px-4 py-2 rounded-2xl text-sm font-medium transition shadow-sm border ${tab===id ? "bg-black text-white":"bg-white hover:bg-gray-50 text-gray-800"}`}>{children}</button>);

        return (
          <div className="min-h-screen p-4 pb-24">
            <div className="max-w-5xl mx-auto">
              <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <h1 className="text-2xl font-bold">Print Sales Tracker</h1>
                <div className="flex items-center gap-2">
                  <div className="hidden sm:flex gap-2">
                    {[["sales","Sales"],["items","Items"],["expenses","Expenses"],["analytics","Analytics"],["time","Time"]].map(([id,label])=>(<TabButton key={id} id={id}>{label}</TabButton>))}
                  </div>
                  <select className="ml-2 px-3 py-2 rounded-xl bg-white border" value={currency} onChange={(e)=>setCurrency(e.target.value)}>
                    <option value="£">£ GBP</option><option value="$">$ USD</option><option value="€">€ EUR</option><option value="¥">¥ JPY</option>
                  </select>
                </div>
              </header>

              <div className="mb-3 flex flex-wrap gap-2">
                <button onClick={exportSalesCSV} className="px-3 py-2 rounded-xl border bg-white">Export Sales CSV</button>
                <button onClick={exportItemsCSV} className="px-3 py-2 rounded-xl border bg-white">Export Items CSV</button>
                <button onClick={exportExpensesCSV} className="px-3 py-2 rounded-xl border bg-white">Export Expenses CSV</button>
                <button onClick={exportAnalyticsCSV} className="px-3 py-2 rounded-xl border bg-white">Export Analytics CSV</button>
              </div>

              {tab==="sales" && (
                <div className="bg-white rounded-2xl p-4 shadow">
                  <div className="grid grid-cols-1 sm:grid-cols-6 gap-2 mb-4">
                    <select className="px-3 py-2 rounded-xl border w-full" value={saleForm.item} onChange={(e)=>setSaleForm({...saleForm, item:e.target.value})}>
                      {items.filter(i=>!i.removed).map(i=>(<option key={i.id}>{i.name}</option>))}
                    </select>
                    <input className="px-3 py-2 rounded-xl border w-full" type="number" placeholder="Price" value={saleForm.price} onChange={(e)=>setSaleForm({...saleForm, price:e.target.value})} />
                    <select className="px-3 py-2 rounded-xl border w-full" value={saleForm.channel} onChange={(e)=>setSaleForm({...saleForm, channel:e.target.value})}>
                      {channels.map(c=>(<option key={c}>{c}</option>))}
                    </select>
                    <input className="px-3 py-2 rounded-xl border w-full" type="number" placeholder="Tax %" value={saleForm.taxRate} onChange={(e)=>setSaleForm({...saleForm, taxRate:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" type="date" value={saleForm.date} onChange={(e)=>setSaleForm({...saleForm, date:e.target.value})} />
                    <button onClick={addSale} className="px-4 py-2 rounded-2xl bg-black text-white w-full">Add Sale</button>
                  </div>

                  <div className="hidden sm:block overflow-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left border-b bg-gray-50">
                          {["date","item","channel","filamentCost","powerCost","otherCosts","deliveryCost","totalCost","price","taxAmount","profit","printingTime"].map(c=>(<th key={c} className="p-2 capitalize">{c}</th>))}
                          <th className="p-2">Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sales.map((s,i)=>(
                          <tr key={i} className="border-b">
                            <td className="p-2">{s.date}</td><td className="p-2">{s.item}</td><td className="p-2">{s.channel}</td>
                            <td className="p-2">{fmtMoney(currency, s.filamentCost)}</td><td className="p-2">{fmtMoney(currency, s.powerCost)}</td>
                            <td className="p-2">{fmtMoney(currency, s.otherCosts)}</td><td className="p-2">{fmtMoney(currency, s.deliveryCost)}</td>
                            <td className="p-2">{fmtMoney(currency, s.totalCost)}</td><td className="p-2">{fmtMoney(currency, s.price)}</td>
                            <td className="p-2">{fmtMoney(currency, s.taxAmount)}</td><td className="p-2">{fmtMoney(currency, s.profit)}</td>
                            <td className="p-2">{s.printingTime} hrs</td><td className="p-2"><button onClick={()=>deleteSale(i)} className="text-red-600">Delete</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div className="sm:hidden space-y-3">
                    {sales.map((s,i)=>(
                      <div key={i} className="rounded-2xl border p-3 bg-white">
                        <div className="flex justify-between text-sm mb-1"><b>{s.item}</b><span>{s.date}</span></div>
                        <div className="text-xs text-gray-500 mb-2">{s.channel}</div>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                          <div>Total: {fmtMoney(currency, s.totalCost)}</div>
                          <div>Price: {fmtMoney(currency, s.price)}</div>
                          <div>Tax: {fmtMoney(currency, s.taxAmount)}</div>
                          <div>Profit: {fmtMoney(currency, s.profit)}</div>
                          <div className="col-span-2">Time: {s.printingTime} hrs</div>
                        </div>
                        <div className="mt-2 flex justify-end"><button onClick={()=>deleteSale(i)} className="text-red-600">Delete</button></div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {tab==="items" && (
                <div className="bg-white rounded-2xl p-4 shadow">
                  <div className="grid grid-cols-1 sm:grid-cols-6 gap-2 mb-4">
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Name" value={newItem.name} onChange={(e)=>setNewItem({...newItem, name:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Filament Cost" type="number" value={newItem.filamentCost} onChange={(e)=>setNewItem({...newItem, filamentCost:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Power Cost" type="number" value={newItem.powerCost} onChange={(e)=>setNewItem({...newItem, powerCost:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Other Costs" type="number" value={newItem.otherCosts} onChange={(e)=>setNewItem({...newItem, otherCosts:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Printing Time (hrs)" type="number" value={newItem.printingTime} onChange={(e)=>setNewItem({...newItem, printingTime:e.target.value})} />
                    <button onClick={addItem} className="px-4 py-2 rounded-2xl bg-black text-white w-full">Add Item</button>
                  </div>

                  <div className="hidden sm:block overflow-auto">
                    <table className="w-full text-sm">
                      <thead><tr className="text-left border-b bg-gray-50"><th className="p-2">Name</th><th className="p-2">Filament</th><th className="p-2">Power</th><th className="p-2">Other</th><th className="p-2">Time</th><th className="p-2">Status</th><th className="p-2">Actions</th></tr></thead>
                      <tbody>
                      {items.map((it, idx)=>(
                        <tr key={it.id} className="border-b">
                          <td className="p-2"><input className="px-2 py-1 rounded border w-full" value={it.name} onChange={(e)=>{ setItems(prev=>{ const u=[...prev]; u[idx].name=e.target.value; return u; }); }} /></td>
                          <td className="p-2"><input className="px-2 py-1 rounded border w-28" type="number" value={it.filamentCost} onChange={(e)=>{ setItems(prev=>{ const u=[...prev]; u[idx].filamentCost=parseFloat(e.target.value)||0; return u; }); }} /></td>
                          <td className="p-2"><input className="px-2 py-1 rounded border w-28" type="number" value={it.powerCost} onChange={(e)=>{ setItems(prev=>{ const u=[...prev]; u[idx].powerCost=parseFloat(e.target.value)||0; return u; }); }} /></td>
                          <td className="p-2"><input className="px-2 py-1 rounded border w-28" type="number" value={it.otherCosts} onChange={(e)=>{ setItems(prev=>{ const u=[...prev]; u[idx].otherCosts=parseFloat(e.target.value)||0; return u; }); }} /></td>
                          <td className="p-2"><input className="px-2 py-1 rounded border w-28" type="number" value={it.printingTime} onChange={(e)=>{ setItems(prev=>{ const u=[...prev]; u[idx].printingTime=parseFloat(e.target.value)||0; return u; }); }} /></td>
                          <td className="p-2">{it.removed?"Removed":"Active"}</td>
                          <td className="p-2"><button onClick={()=>{ setItems(prev=>{ const u=[...prev]; u[idx].removed=!u[idx].removed; return u; }); }} className="px-3 py-1 rounded-2xl border bg-white">{it.removed?"Restore":"Remove"}</button></td>
                        </tr>
                      ))}
                      </tbody>
                    </table>
                  </div>

                  <div className="mt-4 grid grid-cols-1 sm:flex gap-2 items-end">
                    <input className="px-3 py-2 rounded-xl border w-full sm:w-auto" placeholder="Add a new channel" value={newChannel} onChange={(e)=>setNewChannel(e.target.value)} />
                    <button onClick={()=>{ if(!newChannel.trim()) return; setChannels(prev=> Array.from(new Set([...prev, newChannel.trim()]))); setNewChannel(""); }} className="px-4 py-2 rounded-2xl bg-white border w-full sm:w-auto">Add Channel</button>
                  </div>
                </div>
              )}

              {tab==="expenses" && (
                <div className="bg-white rounded-2xl p-4 shadow">
                  <div className="grid grid-cols-1 sm:grid-cols-6 gap-2 mb-4">
                    <select className="px-3 py-2 rounded-xl border w-full" value={newExpense.category} onChange={(e)=>setNewExpense({...newExpense, category:e.target.value})}>
                      {["Machine Repairs","Filament Purchase","Waste Filament","Packaging Materials","Power Bill","Software Subscription","Marketing/Ads","Other"].map(c=>(<option key={c}>{c}</option>))}
                    </select>
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Description" value={newExpense.name} onChange={(e)=>setNewExpense({...newExpense, name:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" placeholder="Cost" type="number" value={newExpense.cost} onChange={(e)=>setNewExpense({...newExpense, cost:e.target.value})} />
                    <input className="px-3 py-2 rounded-xl border w-full" type="date" value={newExpense.date} onChange={(e)=>setNewExpense({...newExpense, date:e.target.value})} />
                    <button onClick={()=>{ if(!newExpense.name.trim() || !newExpense.cost) return; setExpenses(prev=>[...prev, { ...newExpense, name: newExpense.name.trim(), cost: parseFloat(newExpense.cost), auto:false }]); setNewExpense({ category: "Machine Repairs", name: "", cost: "", date: todayISO() }); }} className="px-4 py-2 rounded-2xl bg-black text-white w-full">Add Expense</button>
                    <label className="text-sm flex items-center gap-2 w-full"><input type="checkbox" checked={showCOGS} onChange={(e)=>setShowCOGS(e.target.checked)} /> Show COGS</label>
                  </div>

                  <div className="hidden sm:block overflow-auto mb-6">
                    <table className="w-full text-sm">
                      <thead><tr className="text-left border-b bg-gray-50"><th className="p-2">Date</th><th className="p-2">Category</th><th className="p-2">Description</th><th className="p-2">Cost</th><th className="p-2">Delete</th></tr></thead>
                      <tbody>
                        {filteredExpenses.map((e,i)=>(
                          <tr key={`${e.name}-${i}`} className="border-b">
                            <td className="p-2">{e.date}</td><td className="p-2">{e.category}</td><td className="p-2">{e.name}</td>
                            <td className="p-2">{fmtMoney(currency, e.cost)}</td>
                            <td className="p-2">{!e.auto && (<button onClick={()=>setExpenses(prev=>{ const u=[...prev]; u.splice(i,1); return u; })} className="text-red-600">Delete</button>)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-gray-50 rounded-2xl p-3">
                      <h3 className="font-semibold mb-2">Expense Breakdown</h3>
                      <div className="w-full h-72">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie dataKey="value" data={(()=>{ const summary={}; (showCOGS?expenses:expenses.filter(e=>!e.category.startsWith("COGS –"))).forEach(e=>{ if(e.category==="Filament Purchase") return; summary[e.category]=(summary[e.category]||0)+(e.cost||0); }); const totalFil=Math.max(0, totalFilamentPurchase-totalFilamentUsed); if(totalFil>0) summary["Filament Purchase (net)"]=totalFil; return Object.entries(summary).map(([name,value])=>({name,value})); })()} cx="50%" cy="50%" outerRadius={100} label>
                              {(()=>{ const arr=(()=>{ const summary={}; (showCOGS?expenses:expenses.filter(e=>!e.category.startsWith("COGS –"))).forEach(e=>{ if(e.category==="Filament Purchase") return; summary[e.category]=(summary[e.category]||0)+(e.cost||0); }); const totalFil=Math.max(0, totalFilamentPurchase-totalFilamentUsed); if(totalFil>0) summary["Filament Purchase (net)"]=totalFil; return Object.entries(summary).map(([name,value])=>({name,value})); })(); return arr.map((_,idx)=>(<Cell key={idx} fill={`hsl(${idx*47},70%,50%)`} />)); })()}
                            </Pie>
                            <Tooltip formatter={(val)=>fmtMoney(currency,val)} />
                            <Legend />
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                    <div className="bg-gray-50 rounded-2xl p-3">
                      <h3 className="font-semibold mb-2">Quick Totals</h3>
                      <ul className="text-sm space-y-1">
                        <li>Net Filament Purchase: <b>{fmtMoney(currency, netFilamentCost)}</b></li>
                        <li>Total Filament Purchased: {fmtMoney(currency, totalFilamentPurchase)}</li>
                        <li>Total Filament Used (COGS): {fmtMoney(currency, totalFilamentUsed)}</li>
                      </ul>
                    </div>
                  </div>
                </div>
              )}

              {tab==="analytics" && (
                <div className="bg-white rounded-2xl p-4 shadow space-y-4">
                  <div className="flex flex-wrap items-end gap-3 bg-gray-50 p-3 rounded-2xl border">
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-gray-600">From</label>
                      <input className="px-3 py-2 rounded-xl border" type="date" value={rangeStart} onChange={(e)=>setRangeStart(e.target.value)} />
                    </div>
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-gray-600">To</label>
                      <input className="px-3 py-2 rounded-xl border" type="date" value={rangeEnd} onChange={(e)=>setRangeEnd(e.target.value)} />
                    </div>
                    <div className="flex items-center gap-2 text-sm">
                      <button className="px-3 py-2 rounded-xl border" onClick={()=>{ const d=[...new Set(sales.map(s=>s.date))].sort(); if(d.length){ setRangeStart(d[Math.max(0,d.length-7)]); setRangeEnd(d[d.length-1]); }}}>Last 7 days</button>
                      <button className="px-3 py-2 rounded-xl border" onClick={()=>{ const d=[...new Set(sales.map(s=>s.date))].sort(); if(d.length){ setRangeStart(d[Math.max(0,d.length-30)]); setRangeEnd(d[d.length-1]); }}}>Last 30 days</button>
                      <button className="px-3 py-2 rounded-xl border" onClick={()=>{ const d=[...new Set(sales.map(s=>s.date))].sort(); if(d.length){ setRangeStart(d[0]); setRangeEnd(d[d.length-1]); }}}>All</button>
                    </div>
                    <div className="ml-auto flex items-center gap-2">
                      <span className="inline-flex items-center gap-1 text-xs"><span className="inline-block w-3 h-3 rounded" style={{background:'#2563eb'}}></span>Revenue</span>
                      <span className="inline-flex items-center gap-1 text-xs"><span className="inline-block w-3 h-3 rounded" style={{background:'#ef4444'}}></span>COGS</span>
                      <span className="inline-flex items-center gap-1 text-xs"><span className="inline-block w-3 h-3 rounded" style={{background:'#22c55e'}}></span>Gross</span>
                      <span className="inline-flex items-center gap-1 text-xs"><span className="inline-block w-3 h-3 rounded" style={{background:'#a855f7'}}></span>Net</span>
                    </div>
                  </div>

                  <div>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                      <div className="bg-gray-50 rounded-2xl p-3 border"><div className="text-xs text-gray-500">Revenue</div><div className="text-lg font-semibold">{fmtMoney(currency, totals.revenue)}</div></div>
                      <div className="bg-gray-50 rounded-2xl p-3 border"><div className="text-xs text-gray-500">COGS</div><div className="text-lg font-semibold">{fmtMoney(currency, totals.cogs)}</div></div>
                      <div className="bg-gray-50 rounded-2xl p-3 border"><div className="text-xs text-gray-500">Gross Profit</div><div className="text-lg font-semibold">{fmtMoney(currency, totals.grossProfit)}</div></div>
                      <div className="bg-gray-50 rounded-2xl p-3 border"><div className="text-xs text-gray-500">Other Expenses</div><div className="text-lg font-semibold">{fmtMoney(currency, totals.other)}</div></div>
                      <div className="bg-gray-50 rounded-2xl p-3 border"><div className="text-xs text-gray-500">Net Profit</div><div className="text-lg font-semibold">{fmtMoney(currency, totals.netProfit)}</div></div>
                    </div>
                    <div className="w-full h-80 bg-gray-50 rounded-2xl p-3">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={[
                          { name: "Revenue", value: totals.revenue },
                          { name: "COGS", value: totals.cogs },
                          { name: "Gross Profit", value: totals.grossProfit },
                          { name: "Other", value: totals.other },
                          { name: "Net Profit", value: totals.netProfit }
                        ]}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="name" />
                          <YAxis />
                          <Tooltip formatter={(val)=>fmtMoney(currency,val)} />
                          <Bar dataKey="value">
                            <LabelList dataKey="value" position="top" formatter={(v)=>fmtMoney(currency,v)} />
                            {["#2563eb","#ef4444","#22c55e","#f59e0b","#a855f7"].map((c,i)=>(<Cell key={i} fill={c} />))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>

                  <div className="bg-gray-50 rounded-2xl p-3 border">
                    <div className="flex items-center gap-3 mb-2">
                      <h3 className="font-semibold">Sales-only view</h3>
                      <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={showCash} onChange={(e)=>setShowCash(e.target.checked)} /> Include Cash</label>
                    </div>
                    <div className="w-full h-72">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={[
                          { name: "Revenue", value: salesOnly.active.revenue },
                          { name: "COGS", value: salesOnly.active.cogs },
                          { name: "Gross Profit", value: salesOnly.active.revenue - salesOnly.active.cogs },
                          { name: "Net (after tax)", value: salesOnly.active.revenue - salesOnly.active.cogs - salesOnly.active.tax }
                        ]}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="name" />
                          <YAxis />
                          <Tooltip formatter={(val)=>fmtMoney(currency,val)} />
                          <Bar dataKey="value">
                            <LabelList dataKey="value" position="top" formatter={(v)=>fmtMoney(currency,v)} />
                            {["#2563eb","#ef4444","#22c55e","#a855f7"].map((c,i)=>(<Cell key={i} fill={c} />))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>

                  <div className="bg-gray-50 rounded-2xl p-3 border">
                    <h3 className="font-semibold mb-2">Performance over time</h3>
                    <div className="w-full h-80">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={lineData} margin={{ left: 8, right: 16, top: 8, bottom: 8 }}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="date" />
                          <YAxis />
                          <Tooltip formatter={(val)=>fmtMoney(currency,val)} />
                          <Legend />
                          <Line type="monotone" dataKey="revenue" name="Revenue" stroke="#2563eb" dot={false} />
                          <Line type="monotone" dataKey="cogs" name="COGS" stroke="#ef4444" dot={false} />
                          <Line type="monotone" dataKey="gross" name="Gross" stroke="#22c55e" dot={false} />
                          <Line type="monotone" dataKey="net" name="Net (after tax)" stroke="#a855f7" dot={false} />
                          <Brush dataKey="date" height={20} travellerWidth={8} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
              )}

              {tab==="time" && (
                <div className="bg-white rounded-2xl p-4 shadow">
                  <div className="overflow-auto mb-6">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left border-b bg-gray-50">
                          <th className="p-2">Item</th>
                          <th className="p-2">Total Hours</th>
                          <th className="p-2">Total Profit</th>
                          <th className="p-2">Profit/hour</th>
                          <th className="p-2">Units Sold</th>
                        </tr>
                      </thead>
                      <tbody>
                        {timeData.map((t, i) => (
                          <tr key={i} className="border-b">
                            <td className="p-2">{t.item}</td>
                            <td className="p-2">{t.hours}</td>
                            <td className="p-2">{fmtMoney(currency, t.profit)}</td>
                            <td className="p-2">{fmtMoney(currency, t.profitPerHour)}</td>
                            <td className="p-2">{t.count}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div className="w-full" style={{ height: `${Math.max(300, 50 * timeData.length)}px` }}>
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart layout="vertical" data={timeData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" tickFormatter={(v)=>fmtMoney(currency,v)} />
                        <YAxis type="category" dataKey="item" width={180} />
                        <Tooltip formatter={(v)=>fmtMoney(currency,v)} />
                        <Bar dataKey="profitPerHour">
                          <LabelList dataKey="profitPerHour" position="right" formatter={(v)=>fmtMoney(currency,v)} />
                          {timeData.map((entry, index) => {
                            let color = "#9ca3af";
                            if (entry.profitPerHour === highest) color = "#22c55e";
                            else if (entry.profitPerHour === lowest) color = "#ef4444";
                            return <Cell key={`cell-${index}`} fill={color} />;
                          })}
                        </Bar>
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              )}
            </div>

            <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center bottom-bar">
              {([["sales","Sales"],["items","Items"],["expenses","Expenses"],["analytics","Analytics"],["time","Time"]]).map(([id,label])=> (
                <button key={id} onClick={()=>setTab(id)} className={`flex-1 py-3 text-sm ${tab===id? 'text-black font-semibold':'text-gray-600'}`}>{label}</button>
              ))}
            </nav>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
